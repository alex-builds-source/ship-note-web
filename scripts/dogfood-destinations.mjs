import { mkdirSync, writeFileSync } from "node:fs";
import { resolve } from "node:path";
import { buildDraftFromGitHub } from "../src/web/generate.js";

const root = resolve(process.cwd());
const outDir = resolve(root, "docs/dogfood/latest");
mkdirSync(outDir, { recursive: true });

const scenarios = [
  {
    id: "ship-note-range",
    repo: "alex-builds-source/ship-note",
    baseRef: "v0.1.10",
    targetRef: "v0.1.11",
  },
  {
    id: "repo-preflight-range",
    repo: "alex-builds-source/repo-preflight",
    baseRef: "v0.1.10",
    targetRef: "v0.1.11",
  },
];

const modes = [
  { destination: "release", preset: "standard", includeWhy: false },
  { destination: "update", preset: "standard", includeWhy: false },
  { destination: "social", preset: "short", includeWhy: false },
  { destination: "internal", preset: "standard", includeWhy: true },
];

const summary = [];

for (const sc of scenarios) {
  for (const mode of modes) {
    const result = await buildDraftFromGitHub({
      repoInput: sc.repo,
      baseRef: sc.baseRef,
      targetRef: sc.targetRef,
      preset: mode.preset,
      destination: mode.destination,
      includeWhy: mode.includeWhy,
    });

    const slug = `${sc.id}.${mode.destination}.${mode.preset}${mode.includeWhy ? ".with-why" : ""}`;
    const mdPath = resolve(outDir, `${slug}.md`);
    const jsonPath = resolve(outDir, `${slug}.json`);

    writeFileSync(mdPath, result.markdown, "utf8");
    writeFileSync(jsonPath, JSON.stringify(result, null, 2) + "\n", "utf8");

    summary.push({
      scenario: sc.id,
      repo: sc.repo,
      destination: mode.destination,
      preset: mode.preset,
      includeWhy: mode.includeWhy,
      bullets: result.sections.what_shipped.length,
      hasWhy: result.sections.why_it_matters.length > 0,
      markdownFile: `docs/dogfood/latest/${slug}.md`,
      jsonFile: `docs/dogfood/latest/${slug}.json`,
    });
  }
}

const lines = [
  "# Destination Dogfood Summary",
  "",
  "Generated by `scripts/dogfood-destinations.mjs`.",
  "",
  "| Scenario | Destination | Preset | includeWhy | Bullets | Why? | Markdown | JSON |",
  "|---|---|---|---|---:|---|---|---|",
];

for (const row of summary) {
  lines.push(
    `| ${row.scenario} | ${row.destination} | ${row.preset} | ${row.includeWhy} | ${row.bullets} | ${row.hasWhy} | \`${row.markdownFile}\` | \`${row.jsonFile}\` |`,
  );
}

writeFileSync(resolve(outDir, "SUMMARY.md"), lines.join("\n") + "\n", "utf8");
console.log(`wrote ${summary.length} destination outputs to docs/dogfood/latest`);
