import { readFileSync, writeFileSync, existsSync, mkdirSync } from "node:fs";
import { resolve, dirname } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const root = resolve(__dirname, "..");
const fixturePath = resolve(root, "docs/fixtures/ship-note.schema.v1.json");
const snippetsDir = resolve(root, "docs/snippets");
const docPath = resolve(root, "docs/AGENT_INTEGRATION.md");

const checkMode = process.argv.includes("--check");

function stableJson(obj) {
  return JSON.stringify(obj, null, 2) + "\n";
}

function shellEscapeSingleQuotes(str) {
  return String(str).replace(/'/g, "'\\''");
}

function buildOutputs(fixture) {
  const endpoint = fixture?.service?.endpoint;
  const request = fixture?.request;
  const response = fixture?.response;

  if (!endpoint || !request || !response) {
    throw new Error("Fixture must include service.endpoint, request, and response");
  }

  const requestJson = stableJson(request);
  const responseJson = stableJson(response);

  const curlSnippet = [
    "#!/usr/bin/env bash",
    "set -euo pipefail",
    "",
    `curl -sS -X POST '${endpoint}' \\\n  -H 'content-type: application/json' \\\n  -d '${shellEscapeSingleQuotes(requestJson.trim())}' | jq .`,
    "",
  ].join("\n");

  const pythonSnippet = [
    "import requests",
    "",
    `URL = \"${endpoint}\"`,
    `payload = ${requestJson.trim()}`,
    "",
    "response = requests.post(URL, json=payload, timeout=30)",
    "response.raise_for_status()",
    "data = response.json()",
    "print(data[\"schema_version\"])",
    "print(data[\"sections\"][\"what_shipped\"])",
    "",
  ].join("\n");

  const jsSnippet = [
    `const url = \"${endpoint}\";`,
    `const payload = ${requestJson.trim()};`,
    "",
    "const res = await fetch(url, {",
    "  method: \"POST\",",
    "  headers: { \"content-type\": \"application/json\" },",
    "  body: JSON.stringify(payload),",
    "});",
    "if (!res.ok) throw new Error(`HTTP ${res.status}`);",
    "const data = await res.json();",
    "console.log(data.schema_version);",
    "console.log(data.sections.what_shipped);",
    "",
  ].join("\n");

  const doc = [
    "# Agent Integration Examples",
    "",
    "_This file is generated by `scripts/generate-snippets.mjs`. Do not edit manually._",
    "",
    "These examples are generated from one canonical fixture:",
    "- `docs/fixtures/ship-note.schema.v1.json`",
    "",
    "## Canonical request",
    "```json",
    requestJson.trim(),
    "```",
    "",
    "## Canonical response",
    "```json",
    responseJson.trim(),
    "```",
    "",
    "## cURL",
    "```bash",
    curlSnippet.trim(),
    "```",
    "",
    "## Python",
    "```python",
    pythonSnippet.trim(),
    "```",
    "",
    "## JavaScript",
    "```javascript",
    jsSnippet.trim(),
    "```",
    "",
  ].join("\n");

  return {
    [resolve(snippetsDir, "request.json")]: requestJson,
    [resolve(snippetsDir, "response.json")]: responseJson,
    [resolve(snippetsDir, "curl.sh")]: curlSnippet,
    [resolve(snippetsDir, "python.py")]: pythonSnippet,
    [resolve(snippetsDir, "javascript.mjs")]: jsSnippet,
    [docPath]: doc,
  };
}

function writeOrCheck(path, content) {
  if (!existsSync(path)) {
    if (checkMode) {
      throw new Error(`Missing generated file: ${path}`);
    }
    mkdirSync(dirname(path), { recursive: true });
    writeFileSync(path, content, "utf8");
    return;
  }

  const existing = readFileSync(path, "utf8");
  if (existing === content) return;

  if (checkMode) {
    throw new Error(`Generated file out of date: ${path}`);
  }

  writeFileSync(path, content, "utf8");
}

function main() {
  const fixture = JSON.parse(readFileSync(fixturePath, "utf8"));
  const outputs = buildOutputs(fixture);

  for (const [path, content] of Object.entries(outputs)) {
    writeOrCheck(path, content);
  }

  console.log(checkMode ? "snippets:check ok" : "snippets:generate wrote files");
}

main();
