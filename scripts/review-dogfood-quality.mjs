import { readdirSync, readFileSync, writeFileSync } from "node:fs";
import { resolve } from "node:path";

const root = resolve(process.cwd());
const dogfoodDir = resolve(root, "docs/dogfood/latest");
const outPath = resolve(dogfoodDir, "QUALITY_REPORT.md");

const mdFiles = readdirSync(dogfoodDir)
  .filter((name) => name.endsWith(".md") && name !== "SUMMARY.md" && name !== "QUALITY_REPORT.md")
  .sort();

function bulletLines(text) {
  return text
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter((line) => line.startsWith("- "))
    .map((line) => line.slice(2));
}

function scoreText(text) {
  const bullets = bulletLines(text);
  const longBullets = bullets.filter((b) => b.length > 110).length;
  const codeyBullets = bullets.filter((b) => /`.+`/.test(b)).length;
  const metaBullets = bullets.filter((b) => /flag|changelog|sections\.|raw commit|distills raw|regression coverage/i.test(b)).length;

  const total = bullets.length || 1;
  const penalty = longBullets * 2 + codeyBullets + metaBullets * 2;
  const score = Math.max(0, 100 - Math.round((penalty / total) * 20));

  return {
    bullets: bullets.length,
    longBullets,
    codeyBullets,
    metaBullets,
    score,
  };
}

const rows = mdFiles.map((file) => {
  const text = readFileSync(resolve(dogfoodDir, file), "utf8");
  return { file, ...scoreText(text) };
});

const avgScore = rows.length ? (rows.reduce((sum, r) => sum + r.score, 0) / rows.length).toFixed(1) : "0.0";

const lines = [
  "# Destination Dogfood Quality Report",
  "",
  "Generated by `scripts/review-dogfood-quality.mjs`.",
  "",
  `- Files reviewed: ${rows.length}`,
  `- Average score: ${avgScore}/100`,
  "",
  "## Metrics",
  "| File | Bullets | Long | Codey | Meta | Score |",
  "|---|---:|---:|---:|---:|---:|",
];

for (const r of rows) {
  lines.push(`| ${r.file} | ${r.bullets} | ${r.longBullets} | ${r.codeyBullets} | ${r.metaBullets} | ${r.score} |`);
}

lines.push(
  "",
  "## Notes",
  "- `Long` = bullet lines over 110 characters.",
  "- `Codey` = bullets containing inline code formatting.",
  "- `Meta` = bullets that read like process/mechanics rather than change impact.",
  ""
);

writeFileSync(outPath, lines.join("\n"), "utf8");
console.log(`wrote ${outPath}`);
